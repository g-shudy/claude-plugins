#!/bin/bash
# contacts-search - Search Apple Contacts
# Fixed version that properly exports ALL phones and emails (not just first)

set -euo pipefail

show_help() {
  cat <<EOF
Usage: contacts-search [OPTIONS] [QUERY]

Search for contacts in Apple Contacts app.

Arguments:
  [QUERY]                    Search term (name, email, phone, company)

Options:
  -h, --help                 Show this help message
  -j, --json                 Output as JSON
  -l, --limit N              Limit results to N contacts (default: 20)
  -a, --all                  Show all contacts (no limit)

Examples:
  contacts-search john                # Search for "john"
  contacts-search "Smith"             # Search for "Smith"
  contacts-search -l 5 tech           # First 5 matches for "tech"
  contacts-search -a -j               # All contacts as JSON

Output format (JSON):
  {
    "count": N,
    "contacts": [
      {
        "name": "John Doe",
        "phones": [{"label": "mobile", "number": "+1234567890"}],
        "emails": [{"label": "home", "address": "john@example.com"}],
        "company": "Acme Corp"
      }
    ]
  }

Exit codes:
  0    Success
  1    Invalid arguments
  2    Error querying Contacts.app

Notes:
  • Search is case-insensitive
  • Searches across: first name, last name, email, phone, company
  • Does not require Contacts.app to be running
  • Exports ALL phone numbers and emails (not just first)
EOF
}

# Parse arguments
QUERY=""
JSON=false
LIMIT=20
ALL=false

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help)
      show_help
      exit 0
      ;;
    -j|--json)
      JSON=true
      shift
      ;;
    -l|--limit)
      LIMIT="$2"
      shift 2
      ;;
    -a|--all)
      ALL=true
      shift
      ;;
    *)
      QUERY="$1"
      shift
      ;;
  esac
done

# Require JSON mode for now (non-JSON output not yet implemented in fixed version)
if [[ "$JSON" == "false" ]]; then
    echo "Error: This version requires -j (JSON output)" >&2
    echo "Usage: contacts-search -j [-a|QUERY]" >&2
    exit 1
fi

# Build AppleScript that outputs proper JSON
if [[ "$ALL" == "true" ]]; then
    # List all contacts
    APPLESCRIPT='
tell application "Contacts"
    set allPeople to every person
    set jsonArray to "["
    set firstContact to true

    repeat with aPerson in allPeople
        if not firstContact then
            set jsonArray to jsonArray & ","
        end if
        set firstContact to false

        -- Get name
        try
            set personName to name of aPerson
        on error
            set personName to "(No name)"
        end try
        set personName to my replaceText(personName, "\"", "\\\"")

        -- Build phones array
        set phonesJson to "["
        set firstPhone to true
        try
            repeat with aPhone in phones of aPerson
                try
                    if not firstPhone then
                        set phonesJson to phonesJson & ","
                    end if
                    set firstPhone to false

                    set phoneLabel to label of aPhone
                    set phoneValue to value of aPhone
                    set phoneLabel to my cleanLabel(phoneLabel)
                    set phoneLabel to my replaceText(phoneLabel, "\"", "\\\"")
                    set phoneValue to my replaceText(phoneValue, "\"", "\\\"")

                    set phonesJson to phonesJson & "{\"label\":\"" & phoneLabel & "\",\"number\":\"" & phoneValue & "\"}"
                end try
            end repeat
        end try
        set phonesJson to phonesJson & "]"

        -- Build emails array
        set emailsJson to "["
        set firstEmail to true
        try
            repeat with anEmail in emails of aPerson
                try
                    if not firstEmail then
                        set emailsJson to emailsJson & ","
                    end if
                    set firstEmail to false

                    set emailLabel to label of anEmail
                    set emailValue to value of anEmail
                    set emailLabel to my cleanLabel(emailLabel)
                    set emailLabel to my replaceText(emailLabel, "\"", "\\\"")
                    set emailValue to my replaceText(emailValue, "\"", "\\\"")

                    set emailsJson to emailsJson & "{\"label\":\"" & emailLabel & "\",\"address\":\"" & emailValue & "\"}"
                end try
            end repeat
        end try
        set emailsJson to emailsJson & "]"

        -- Get company
        try
            set personCompany to organization of aPerson
            set personCompany to my replaceText(personCompany, "\"", "\\\"")
        on error
            set personCompany to ""
        end try

        -- Build contact JSON
        set jsonArray to jsonArray & "{\"name\":\"" & personName & "\",\"phones\":" & phonesJson & ",\"emails\":" & emailsJson & ",\"company\":\"" & personCompany & "\"}"
    end repeat

    set jsonArray to jsonArray & "]"
    return "{\"count\":" & (count of allPeople) & ",\"contacts\":" & jsonArray & "}"
end tell

on replaceText(theText, oldChar, newChar)
    set AppleScript'"'"'s text item delimiters to oldChar
    set textItems to text items of theText
    set AppleScript'"'"'s text item delimiters to newChar
    set newText to textItems as text
    set AppleScript'"'"'s text item delimiters to ""
    return newText
end replaceText

on cleanLabel(labelText)
    -- Remove AppleScript label formatting: _$!<Label>!$_ -> Label
    set cleanedLabel to labelText
    if cleanedLabel starts with "_$!<" then
        set cleanedLabel to text 5 thru -5 of cleanedLabel
    end if
    return cleanedLabel
end cleanLabel
'
elif [[ -n "$QUERY" ]]; then
    # Search for specific term
    QUERY_ESCAPED=$(echo "$QUERY" | sed "s/'/\\\\'/g")
    APPLESCRIPT='
tell application "Contacts"
    set searchTerm to "'"$QUERY_ESCAPED"'"
    set matchingPeople to (every person whose name contains searchTerm or organization contains searchTerm or value of emails contains searchTerm or value of phones contains searchTerm)

    set jsonArray to "["
    set firstContact to true
    set counter to 0

    repeat with aPerson in matchingPeople
        set counter to counter + 1
        if counter > '"$LIMIT"' then exit repeat

        if not firstContact then
            set jsonArray to jsonArray & ","
        end if
        set firstContact to false

        -- Get name
        try
            set personName to name of aPerson
        on error
            set personName to "(No name)"
        end try
        set personName to my replaceText(personName, "\"", "\\\"")

        -- Build phones array
        set phonesJson to "["
        set firstPhone to true
        try
            repeat with aPhone in phones of aPerson
                try
                    if not firstPhone then
                        set phonesJson to phonesJson & ","
                    end if
                    set firstPhone to false

                    set phoneLabel to label of aPhone
                    set phoneValue to value of aPhone
                    set phoneLabel to my cleanLabel(phoneLabel)
                    set phoneLabel to my replaceText(phoneLabel, "\"", "\\\"")
                    set phoneValue to my replaceText(phoneValue, "\"", "\\\"")

                    set phonesJson to phonesJson & "{\"label\":\"" & phoneLabel & "\",\"number\":\"" & phoneValue & "\"}"
                end try
            end repeat
        end try
        set phonesJson to phonesJson & "]"

        -- Build emails array
        set emailsJson to "["
        set firstEmail to true
        try
            repeat with anEmail in emails of aPerson
                try
                    if not firstEmail then
                        set emailsJson to emailsJson & ","
                    end if
                    set firstEmail to false

                    set emailLabel to label of anEmail
                    set emailValue to value of anEmail
                    set emailLabel to my cleanLabel(emailLabel)
                    set emailLabel to my replaceText(emailLabel, "\"", "\\\"")
                    set emailValue to my replaceText(emailValue, "\"", "\\\"")

                    set emailsJson to emailsJson & "{\"label\":\"" & emailLabel & "\",\"address\":\"" & emailValue & "\"}"
                end try
            end repeat
        end try
        set emailsJson to emailsJson & "]"

        -- Get company
        try
            set personCompany to organization of aPerson
            set personCompany to my replaceText(personCompany, "\"", "\\\"")
        on error
            set personCompany to ""
        end try

        -- Build contact JSON
        set jsonArray to jsonArray & "{\"name\":\"" & personName & "\",\"phones\":" & phonesJson & ",\"emails\":" & emailsJson & ",\"company\":\"" & personCompany & "\"}"
    end repeat

    set jsonArray to jsonArray & "]"
    return "{\"count\":" & counter & ",\"contacts\":" & jsonArray & "}"
end tell

on replaceText(theText, oldChar, newChar)
    set AppleScript'"'"'s text item delimiters to oldChar
    set textItems to text items of theText
    set AppleScript'"'"'s text item delimiters to newChar
    set newText to textItems as text
    set AppleScript'"'"'s text item delimiters to ""
    return newText
end replaceText

on cleanLabel(labelText)
    -- Remove AppleScript label formatting: _$!<Label>!$_ -> Label
    set cleanedLabel to labelText
    if cleanedLabel starts with "_$!<" then
        set cleanedLabel to text 5 thru -5 of cleanedLabel
    end if
    return cleanedLabel
end cleanLabel
'
else
    echo "Error: Provide a search query or use --all to list all contacts" >&2
    exit 1
fi

# Execute query
RESULT=$(osascript -e "$APPLESCRIPT" 2>&1)

# Check for errors
if [[ $? -ne 0 ]]; then
    echo "Error: Failed to query Contacts.app" >&2
    echo "$RESULT" >&2
    exit 2
fi

# Output result
echo "$RESULT"
