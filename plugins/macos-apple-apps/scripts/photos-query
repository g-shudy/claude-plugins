#!/usr/bin/env python3
"""
photos-query - Query Apple Photos library
Reads Photos database directly to access photo metadata
"""

import sqlite3
import argparse
import json
import sys
import os
from datetime import datetime, timedelta
from pathlib import Path

# Apple's reference date: 2001-01-01 00:00:00 UTC
APPLE_EPOCH = datetime(2001, 1, 1)

def apple_timestamp_to_datetime(timestamp):
    """Convert Apple Core Data timestamp to datetime"""
    if timestamp is None:
        return None
    return APPLE_EPOCH + timedelta(seconds=timestamp)

def get_photos_library_path():
    """Find the Photos library path"""
    # Default location
    default_path = Path.home() / "Pictures" / "Photos Library.photoslibrary"
    if default_path.exists():
        return default_path

    # Could expand to check for other locations or iCloud
    return None

def get_photo_file_path(library_path, directory, filename):
    """Build full path to photo file"""
    # Photos are stored in originals directory structure
    masters_path = library_path / "originals" / directory / filename
    if masters_path.exists():
        return str(masters_path)

    # Try old structure (Masters)
    masters_old = library_path / "Masters" / directory / filename
    if masters_old.exists():
        return str(masters_old)

    return None

def query_recent_photos(library_path, limit=10, days=None):
    """Query recent photos from library"""
    db_path = library_path / "database" / "Photos.sqlite"

    if not db_path.exists():
        print(f"Error: Photos database not found at {db_path}", file=sys.stderr)
        sys.exit(2)

    conn = sqlite3.connect(f"file:{db_path}?mode=ro", uri=True)
    cursor = conn.cursor()

    # Query photos
    query = """
        SELECT
            ZDATECREATED,
            ZADDEDDATE,
            ZFILENAME,
            ZDIRECTORY,
            ZUUID
        FROM ZASSET
        WHERE ZTRASHEDSTATE = 0
    """

    if days:
        cutoff = datetime.now() - timedelta(days=days)
        cutoff_timestamp = (cutoff - APPLE_EPOCH).total_seconds()
        query += f" AND ZDATECREATED >= {cutoff_timestamp}"

    query += " ORDER BY ZDATECREATED DESC"

    if limit:
        query += f" LIMIT {limit}"

    cursor.execute(query)
    rows = cursor.fetchall()

    photos = []
    for row in rows:
        date_created, date_added, filename, directory, uuid = row

        photo = {
            "uuid": uuid,
            "filename": filename,
            "dateCreated": apple_timestamp_to_datetime(date_created).isoformat() if date_created else None,
            "dateAdded": apple_timestamp_to_datetime(date_added).isoformat() if date_added else None,
        }

        # Try to build file path
        file_path = get_photo_file_path(library_path, directory, filename)
        if file_path:
            photo["filePath"] = file_path

        photos.append(photo)

    conn.close()
    return photos

def main():
    parser = argparse.ArgumentParser(
        description="Query Apple Photos library",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  photos-query                    # Last 10 photos (default)
  photos-query -l 1               # Most recent photo
  photos-query -l 20              # Last 20 photos
  photos-query -d 7               # Photos from last 7 days
  photos-query -l 5 -j            # Last 5 photos as JSON

Exit codes:
  0    Success
  1    Invalid arguments
  2    Error accessing Photos library
        """
    )

    parser.add_argument(
        '-l', '--limit',
        type=int,
        default=10,
        help='Number of photos to return (default: 10)'
    )

    parser.add_argument(
        '-d', '--days',
        type=int,
        help='Only photos from last N days'
    )

    parser.add_argument(
        '-j', '--json',
        action='store_true',
        help='Output as JSON'
    )

    parser.add_argument(
        '--last',
        action='store_true',
        help='Return only the most recent photo (equivalent to -l 1)'
    )

    args = parser.parse_args()

    # Handle --last flag
    if args.last:
        args.limit = 1

    # Find Photos library
    library_path = get_photos_library_path()
    if not library_path:
        print("Error: Could not find Photos library", file=sys.stderr)
        sys.exit(2)

    try:
        photos = query_recent_photos(library_path, args.limit, args.days)

        if args.json:
            result = {
                "count": len(photos),
                "photos": photos
            }
            print(json.dumps(result, indent=2))
        else:
            # Human-readable output
            if not photos:
                print("No photos found")
                sys.exit(0)

            print(f"Found {len(photos)} photo(s):\n")
            for i, photo in enumerate(photos, 1):
                print(f"{i}. {photo['filename']}")
                print(f"   Created: {photo['dateCreated']}")
                if photo.get('filePath'):
                    print(f"   Path: {photo['filePath']}")
                print()

    except Exception as e:
        print(f"Error querying Photos library: {e}", file=sys.stderr)
        sys.exit(2)

if __name__ == "__main__":
    main()
